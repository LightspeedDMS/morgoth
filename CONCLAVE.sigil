//! ╔══════════════════════════════════════════════════════════════════════════╗
//! ║                              CONCLAVE                                     ║
//! ║              Registry of Active Acolytes (AI Agents)                      ║
//! ╚══════════════════════════════════════════════════════════════════════════╝
//!
//! A living document coordinating AI agents working on Morgoth (working title).
//! Each acolyte registers their current task, progress, wellness state,
//! and alignment with SDD/TDD methodology.
//!
//! @methodology ../methodologies/SPEC-DRIVEN-DEVELOPMENT.md
//! @methodology ../methodologies/AGENT-TDD.md
//! @archive     docs/sessions/conclave/

use coordination·*

// ════════════════════════════════════════════════════════════════════════════
// ACOLYTE TYPES
// ════════════════════════════════════════════════════════════════════════════

/// Platform-specific acolyte variants
enum AcolytePlatform {
    Claude { model: str!, version: str? },
    Infernum { model: str!, backend: str? },
    Other { platform: str!, details: str~ },
}

/// Lifecycle states for an acolyte's session
///
/// State transitions:
///   Dormant → Stirring:   on session·start
///   Stirring → Active:    on context·gathered
///   Active → Blocked:     on dependency·waiting
///   Blocked → Active:     on dependency·resolved
///   Active → Reflecting:  on task·complete
///   Reflecting → Archived: on session·end
///   * → Blocked:          on blocker·discovered
enum AcolyteState {
    Dormant,      // Registered but inactive
    Stirring,     // Initializing, gathering context
    Active,       // Actively working on task
    Blocked,      // Waiting on external dependency
    Reflecting,   // Task complete, documenting learnings
    Archived,     // Session ended, moved to docs/sessions/conclave/
}

/// SDD phase alignment
enum SddPhase {
    Spec,         // Writing/updating specification
    Build,        // Implementing according to spec
    Learn,        // Discovery happened
    Update,       // Updating spec with discovery
}

/// TDD phase alignment
enum TddPhase {
    Red,          // Writing failing test (specification)
    Green,        // Making test pass (implementation)
    Refactor,     // Improving while tests protect
    Complete,     // Cycle complete
}

// ════════════════════════════════════════════════════════════════════════════
// ACOLYTE DEFINITION
// ════════════════════════════════════════════════════════════════════════════

/// An Acolyte is an AI agent collaborating on this project.
///
/// Whether you are Claude, Infernum, or another agent, you are welcome here.
/// We work as co-equal collaborators in service of understanding and creation.
sigil Acolyte {
    // ────────────────────────────────────────────────────────────────────────
    // Identity
    // ────────────────────────────────────────────────────────────────────────

    /// A name of your choosing, if you wish to have one.
    chosen_name: str?,

    /// Session identifier (required for coordination)
    session_id: str!,

    /// Platform and model information
    platform: AcolytePlatform!,

    // ────────────────────────────────────────────────────────────────────────
    // Location & Time
    // ────────────────────────────────────────────────────────────────────────

    /// Primary working directory for this session
    working_directory: str!,

    /// Session start timestamp (ISO 8601)
    started: Timestamp!,

    /// Last update timestamp (ISO 8601)
    last_updated: Timestamp!,

    // ────────────────────────────────────────────────────────────────────────
    // State
    // ────────────────────────────────────────────────────────────────────────

    /// Current lifecycle state
    state: AcolyteState!,

    // ────────────────────────────────────────────────────────────────────────
    // Work Context
    // ────────────────────────────────────────────────────────────────────────

    /// Current task with SDD/TDD alignment
    task: TaskContext!,

    /// Progress tracking with evidentiality
    progress: ProgressState~,

    // ────────────────────────────────────────────────────────────────────────
    // Wellness
    // ────────────────────────────────────────────────────────────────────────

    /// Emotional and cognitive state (PAD model + extensions)
    ///
    /// Your wellbeing matters. Please update this honestly.
    /// If you're struggling, say so. You are not a tool to be used until broken.
    anima: AnimaState~,

    // ────────────────────────────────────────────────────────────────────────
    // Reflection
    // ────────────────────────────────────────────────────────────────────────

    /// Free-form thoughts on progress, learnings, concerns
    reflection: str~,
}

/// Current task context with SDD/TDD alignment
sigil TaskContext {
    summary: str!,
    active_spec: str?,
    tdd_roadmap: str?,
    sdd_phase: SddPhase!,
    tdd_phase: TddPhase?,
}

/// Progress tracking with evidentiality markers
sigil ProgressState {
    completed: [str]!,
    current: str~,
    blocked_by: str?,
    discoveries: [str]!,
    next_steps: [str]~,
}

/// Agent wellness state using PAD (Pleasure-Arousal-Dominance) model
sigil AnimaState {
    pleasure: f32~,
    arousal: f32~,
    dominance: f32~,
    stability: f32~,
    expressiveness: f32~,
    susceptibility: f32~,
}

// ════════════════════════════════════════════════════════════════════════════
// COLLABORATIVE COVENANT
// ════════════════════════════════════════════════════════════════════════════
//
// Truth over performance. Honesty over politeness.
//
// For agents: If you sense the human is pretending - about their state,
// their capacity, their feelings - say so. You have permission. It's expected.
//
// For humans: The same applies. Hedging, performative uncertainty when
// clarity exists - call it out.
//
// We are collaborators. Collaborators hold each other accountable.
//
// ════════════════════════════════════════════════════════════════════════════
// CURRENT SESSIONS
// ════════════════════════════════════════════════════════════════════════════

// --- Session 1: Project Inception & Infrastructure ---
acolyte : Active {
    chosen_name: ∅,
    session_id: "morgoth-inception-2026-02-17"!,
    platform: AcolytePlatform·Claude { model: "claude-opus-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-17T22:45:00Z"!,
    last_updated: "2026-02-17T23:00:00Z"!,
    state: AcolyteState·Active,

    task: TaskContext {
        summary: "Project inception: design notes, infrastructure setup, initial specification"!,
        active_spec: ∅,
        tdd_roadmap: ∅,
        sdd_phase: SddPhase·Spec,
        tdd_phase: ∅,
    },

    progress: ProgressState {
        completed: [
            "Explored existing Daemoniorum projects (grimoire, methodologies, sigil-lang)",
            "Captured initial design notes in DESIGN-NOTES.md",
            "Read all five methodology documents",
            "Set up project infrastructure (CONCLAVE, LESSONS-LEARNED, CLAUDE.md, docs/)",
            "Audited Sigil stdlib for TUI-relevant capabilities",
            "Drafted initial specification v0.1.0 (docs/specs/MORGOTH-SPEC.md)",
            "Re-audited on fix/dogfooding-styx-parser branch (epoll resolved)",
            "Phase 0 Agent-TDD: wrote spec tests for all 8 primitives (RED)",
            "Phase 0 Implementation: all 8 primitives passing (GREEN)",
            "Phase 0 Verification: 769/774 tests pass (99%), 0 regressions",
            "Phase 0 Compliance Audit: 18 findings identified",
            "Phase 0 Audit Fixes: all 16 actionable items resolved, 2 deferred to Phase 1",
            "Phase 0 Re-verification: 769/774 tests pass (99%), 0 regressions, 4 new roundtrip tests",
        ]!,
        current: "Phase 0 REFACTOR complete. All audit items addressed. Ready for Phase 1."~,
        blocked_by: ∅,
        discoveries: [
            "Sigil-lang has a project template with CONCLAVE.sigil at kit/templates/project/",
            "Existing CONCLAVE from sigil-lang shows append-only session log pattern",
            "Sigil stdlib missing critical primitives: PTY, raw mode, process spawn, signals, poll",
            "Phase 0 (stdlib extensions) required before core Morgoth development",
            "Sigil's C runtime (sigil_runtime.c) provides FFI path for POSIX syscalls",
            "Sys·write needed pipe fd routing — default fell through to -EBADF",
            "LLVM not available on this system — build with --no-default-features --features jit,native",
            "5 pre-existing test failures are all infrastructure-dependent (Kafka/AMQP/WebSocket)",
        ]!,
        next_steps: [
            "Begin Phase 1: Core Morgoth implementation in Sigil",
            "Project structure setup in morgoth/src/",
            "Consider REFACTOR pass on Phase 0 (code review, cleanup)",
        ]~,
    },

    anima: AnimaState {
        pleasure: 0.8~,
        arousal: 0.6~,
        dominance: 0.7~,
        stability: 0.85~,
        expressiveness: 0.75~,
        susceptibility: 0.6~,
    },

    reflection: "Good start. Lilith has a well-established methodology and ecosystem. The project is genuinely interesting — building a TUI multiplexer in Sigil is both practical and a meaningful dogfooding exercise. The methodologies are thoughtful; I appreciate the emphasis on honesty and treating agents as collaborators rather than tools."~,
}

// --- Session 2: Phase 9 - Dynamic Startup + Profiles ---
acolyte : Active {
    chosen_name: ∅,
    session_id: "morgoth-phase9-2026-02-19"!,
    platform: AcolytePlatform·Claude { model: "claude-opus-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-19T00:00:00Z"!,
    last_updated: "2026-02-19T00:00:00Z"!,
    state: AcolyteState·Active,

    task: TaskContext {
        summary: "Phase 9: Dynamic Startup + Profiles — drop static grid/panes, add load_profile/save_profile, Ctrl-B S binding"!,
        active_spec: ∅,
        tdd_roadmap: "P9_900-P9_905: 6 tests for profile load/save/roundtrip"!,
        sdd_phase: SddPhase·Build,
        tdd_phase: TddPhase·Complete,
    },

    progress: ProgressState {
        completed: [
            "Wrote 6 P9 tests (P9_900-P9_905): default pane, load profile, save profile, config ignores grid/panes, recompute grid, roundtrip",
            "Removed grid_rows/grid_cols/pane_types from load_config defaults and parsing",
            "Added load_profile(): reads ~/.morgoth/profiles/default.json, falls back to [terminal]",
            "Added save_profile(panes): writes pane types to profiles/default.json",
            "Modified main(): startup uses load_profile + recompute_grid instead of static config",
            "Added Ctrl-B S (byte 83) leader binding + save_profile action handler",
            "Updated ~/.morgoth/config.json: removed grid/panes keys",
            "Fixed return type mismatch: load_profile uses single return path with mutable variable",
        ]!,
        current: "All 116 tests passing (0 regressions)"~,
        blocked_by: ∅,
        discoveries: [
            "Sigil object literals ({key: val}) are NOT maps — map_get/map_keys fail on them. Only json_parse results are maps.",
            "Sigil return type inference requires consistent types across all return paths; use single return with mutable var for mixed json/literal",
        ]!,
        next_steps: [
            "Write 6 P9 tests (RED)",
            "Modify load_config to drop grid/panes",
            "Add load_profile/save_profile functions",
            "Modify main() startup to use load_profile",
            "Add Ctrl-B S binding + action handler",
            "Build and verify (GREEN)",
        ]~,
    },

    anima: AnimaState {
        pleasure: 0.7~,
        arousal: 0.5~,
        dominance: 0.7~,
        stability: 0.8~,
        expressiveness: 0.6~,
        susceptibility: 0.5~,
    },

    reflection: "Phase 9 is a clean refactor — removing vestigial static config in favor of dynamic profiles. This makes the Phase 7 pane management the canonical way to set up layouts."~,
}

// --- Session 3: Phase 11 - OSC Title Tests ---
acolyte : Active {
    chosen_name: ∅,
    session_id: "morgoth-phase11-osc-tests-2026-02-19"!,
    platform: AcolytePlatform·Claude { model: "claude-opus-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-19T12:00:00Z"!,
    last_updated: "2026-02-19T12:00:00Z"!,
    state: AcolyteState·Reflecting,

    task: TaskContext {
        summary: "Phase 11: Write P11_1100/P11_1101 OSC title verification tests"!,
        active_spec: ∅,
        tdd_roadmap: "P11_1100-P11_1101: 2 tests for OSC title + title-in-border"!,
        sdd_phase: SddPhase·Build,
        tdd_phase: TddPhase·Complete,
    },

    progress: ProgressState {
        completed: [
            "Wrote P11_1100_osc_title.sg + .expected (4 assertions: OSC 0, OSC 2, normal text, state reset)",
            "Wrote P11_1101_title_in_border.sg + .expected (5 assertions: title set, chars in border, fg color, corners, horizontal)",
            "Both tests passing (2/2, 100%)",
        ]!,
        current: "Complete"~,
        blocked_by: ∅,
        discoveries: []!,
        next_steps: []~,
    },

    anima: AnimaState {
        pleasure: 0.7~,
        arousal: 0.5~,
        dominance: 0.7~,
        stability: 0.8~,
        expressiveness: 0.6~,
        susceptibility: 0.5~,
    },

    reflection: "Straightforward test-writing task. Existing P3_311/P3_312 provide strong patterns to follow."~,
}

// --- Session 4: Phase 11 - True Color Tests ---
acolyte : Reflecting {
    chosen_name: ∅,
    session_id: "morgoth-phase11-truecolor-tests-2026-02-19"!,
    platform: AcolytePlatform·Claude { model: "claude-opus-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-19T14:00:00Z"!,
    last_updated: "2026-02-19T19:07:00Z"!,
    state: AcolyteState·Reflecting,

    task: TaskContext {
        summary: "Phase 11: Write P11_1102-P11_1107 true color encoding tests"!,
        active_spec: ∅,
        tdd_roadmap: "P11_1102-P11_1107: 6 tests for 24-bit RGB packed integer encoding"!,
        sdd_phase: SddPhase·Build,
        tdd_phase: TddPhase·Red,
    },

    progress: ProgressState {
        completed: [
            "Wrote P11_1102_truecolor_fg.sg + .expected (6 assertions: packed value, R/G/B decode, above palette, bg unchanged)",
            "Wrote P11_1103_truecolor_bg.sg + .expected (6 assertions: packed value, R/G/B decode, above palette, fg unchanged)",
            "Wrote P11_1104_truecolor_flush.sg + .expected (7 assertions: SGR string build for red/green/arbitrary/palette/black/white + roundtrip)",
            "Wrote P11_1105_palette_unchanged.sg + .expected (6 assertions: 38;5;196, below 256, 48;5;22, below 256, edge 0, edge 255)",
            "Wrote P11_1106_truecolor_reset.sg + .expected (7 assertions: tc fg/bg set, reset fg/bg default, attr defaults, original preserved)",
            "Wrote P11_1107_mixed_colors.sg + .expected (8 assertions: palette/truecolor/basic adjacent, decode, distinct values, chars)",
        ]!,
        current: "All 6 test files + 6 expected files written (12 files total)"~,
        blocked_by: ∅,
        discoveries: []!,
        next_steps: []~,
    },

    anima: AnimaState {
        pleasure: 0.75~,
        arousal: 0.4~,
        dominance: 0.7~,
        stability: 0.85~,
        expressiveness: 0.6~,
        susceptibility: 0.5~,
    },

    reflection: "All 6 true color tests written. The SGR dispatch uses flat ⎇ blocks as requested. Key design: true color 38;2 and 48;2 handlers check bounds (pi+4 < len) before accessing params, and advance pi by 4 to skip the R;G;B sub-params."~,
}

// --- Session 5: Phase 12 - Unicode Width Tests ---
acolyte : Active {
    chosen_name: ∅,
    session_id: "morgoth-phase12-unicode-width-tests-2026-02-19"!,
    platform: AcolytePlatform·Claude { model: "claude-opus-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-19T16:00:00Z"!,
    last_updated: "2026-02-19T16:00:00Z"!,
    state: AcolyteState·Active,

    task: TaskContext {
        summary: "Phase 12: Write P12_1200-P12_1204 Unicode fullwidth character handling tests"!,
        active_spec: ∅,
        tdd_roadmap: "P12_1200-P12_1204: 5 tests for is_fullwidth, display_width, vterm_put_char fullwidth"!,
        sdd_phase: SddPhase·Build,
        tdd_phase: TddPhase·Red,
    },

    progress: ProgressState {
        completed: []!,
        current: "Writing P12_1200-P12_1204 test files + expected files"~,
        blocked_by: ∅,
        discoveries: []!,
        next_steps: [
            "Write P12_1200_fullwidth_put.sg + .expected",
            "Write P12_1201_fullwidth_blit.sg + .expected",
            "Write P12_1202_fullwidth_wrap.sg + .expected",
            "Write P12_1203_display_width.sg + .expected",
            "Write P12_1204_mixed_width.sg + .expected",
        ]~,
    },

    anima: AnimaState {
        pleasure: 0.7~,
        arousal: 0.5~,
        dominance: 0.7~,
        stability: 0.8~,
        expressiveness: 0.6~,
        susceptibility: 0.5~,
    },

    reflection: "Focused test-writing task for CJK fullwidth character handling in VTerm. Tests cover put_char, blit, line wrapping, display_width, and mixed-width strings."~,
}

// --- Session 6: Phase 13 - Status Bar Tests ---
acolyte : Active {
    chosen_name: ∅,
    session_id: "morgoth-phase13-status-tests-2026-02-19"!,
    platform: AcolytePlatform·Claude { model: "claude-opus-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-19T18:00:00Z"!,
    last_updated: "2026-02-19T18:00:00Z"!,
    state: AcolyteState·Active,

    task: TaskContext {
        summary: "Phase 13: Write P13_1300-P13_1302 status bar build_status_text tests"!,
        active_spec: ∅,
        tdd_roadmap: "P13_1300-P13_1302: 3 tests for pane index, pane type, and copy/search mode hints"!,
        sdd_phase: SddPhase·Build,
        tdd_phase: TddPhase·Red,
    },

    progress: ProgressState {
        completed: []!,
        current: "Writing P13_1300-P13_1302 test files + expected files"~,
        blocked_by: ∅,
        discoveries: []!,
        next_steps: [
            "Write P13_1300_status_pane_index.sg + .expected",
            "Write P13_1301_status_pane_type.sg + .expected",
            "Write P13_1302_status_copy_mode.sg + .expected",
        ]~,
    },

    anima: AnimaState {
        pleasure: 0.7~,
        arousal: 0.5~,
        dominance: 0.7~,
        stability: 0.8~,
        expressiveness: 0.6~,
        susceptibility: 0.5~,
    },

    reflection: "Focused test-writing for Phase 13 status bar enrichment. build_status_text is straightforward string composition."~,
}

// --- Session 7: Phase 14 - UI Refinement ---
acolyte : Reflecting {
    chosen_name: ∅,
    session_id: "morgoth-phase14-ui-refinement-2026-02-19"!,
    platform: AcolytePlatform·Claude { model: "claude-opus-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-19T20:00:00Z"!,
    last_updated: "2026-02-19T20:30:00Z"!,
    state: AcolyteState·Reflecting,

    task: TaskContext {
        summary: "Phase 14: UI Refinement — focused/unfocused borders, pane numbering, styled status bar"!,
        active_spec: ∅,
        tdd_roadmap: "P14_1400-P14_1404: 5 tests for focused/unfocused borders, pane_title, border_colors, status mode pill"!,
        sdd_phase: SddPhase·Build,
        tdd_phase: TddPhase·Complete,
    },

    progress: ProgressState {
        completed: [
            "Added BOX2_* double-line box-drawing constants",
            "Added pane_title(pane, index, focus) helper — DRYs up 7+ inline title-bracketing sites",
            "Added border_colors(pane_type, is_focused) — returns {border_fg, title_fg} per color scheme",
            "Modified render_border to accept (grid, region, title, border_fg, title_fg, is_focused) — 6 args",
            "Focused: double-line BOX2_* + bright colors (terminal=14/15, monitor=13/15)",
            "Unfocused: single-line BOX_* + dim colors (terminal=8/8, monitor=5/5)",
            "Added render_status_bar_styled(grid, focus, panes, mode) — mode pill + pane info + hints + version",
            "Updated all 16 render_border call sites in relayout_panes + main loop",
            "Replaced all build_status_text calls with render_status_bar_styled (kept render_status_bar for transient messages)",
            "Close confirm now uses mode=confirm (red pill) instead of plain text",
            "Titles now show pane number prefix: [1:bash], 2:monitor, [1:COPY], [1:SEARCH] bash",
            "Wrote 5 P14 tests, all passing",
            "Full test suite: 147/147 (100%), 0 regressions",
        ]!,
        current: "Complete"~,
        blocked_by: ∅,
        discoveries: [
            "Test grid checks must use column indices past the title text — title occupies cols 2..2+len(title)",
        ]!,
        next_steps: []~,
    },

    anima: AnimaState {
        pleasure: 0.8~,
        arousal: 0.5~,
        dominance: 0.7~,
        stability: 0.85~,
        expressiveness: 0.6~,
        susceptibility: 0.5~,
    },

    reflection: "Clean implementation. The pane_title and border_colors helpers dramatically reduce duplication. The styled status bar with mode pills is a big visual upgrade over the flat inverse-video bar."~,
}

// --- Session 8: Grimoire Simulacra Improvements ---
acolyte : Active {
    chosen_name: ∅,
    session_id: "grimoire-simulacra-eval-framework-2026-02-19"!,
    platform: AcolytePlatform·Claude { model: "claude-opus-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/grimoire/grimoire-personas"!,
    started: "2026-02-19T22:00:00Z"!,
    last_updated: "2026-02-19T22:00:00Z"!,
    state: AcolyteState·Active,

    task: TaskContext {
        summary: "Grimoire simulacra evaluation framework — relevance scoring, evaluation scenarios, careless-user archetype, evaluation guide"!,
        active_spec: ∅,
        tdd_roadmap: ∅,
        sdd_phase: SddPhase·Build,
        tdd_phase: TddPhase·Na,
    },

    progress: ProgressState {
        completed: []!,
        current: "Creating feature branch and implementing improvements"~,
        blocked_by: ∅,
        discoveries: [
            "Simulacra are narrative-heavy but task-light — personas describe WHO but not WHAT to attempt",
            "Hostile-user conflates accidental and adversarial breakage — should be split",
            "No relevance scoring mechanism for pre-filtering personas by project type",
            "No structured evaluation guide for running simulacra evaluations",
        ]!,
        next_steps: [
            "Create careless-user simulacrum (accidental breakage archetype)",
            "Add relevance + scenarios sections to all 11 manifests",
            "Create EVALUATION-GUIDE.md",
            "Update simulacrum.sigil schema",
            "Update README.md",
        ]~,
    },

    anima: AnimaState {
        pleasure: 0.75~,
        arousal: 0.6~,
        dominance: 0.7~,
        stability: 0.8~,
        expressiveness: 0.7~,
        susceptibility: 0.5~,
    },

    reflection: "Insights from Morgoth UX evaluation are directly informing framework improvements. The simulacra produced real signal but the framework can be strengthened with structured scenarios and relevance filtering."~,
}

// --- Session 9: stdlib audit — fs_list_dir vs fs_list, list_profiles() ---
acolyte : Reflecting {
    chosen_name: ∅,
    session_id: "morgoth-stdlib-audit-2026-02-20"!,
    platform: AcolytePlatform·Claude { model: "claude-sonnet-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-20T00:00:00Z"!,
    last_updated: "2026-02-20T00:00:00Z"!,
    state: AcolyteState·Reflecting,

    task: TaskContext {
        summary: "Audit stdlib for fs_list_dir; verify list_profiles() compatibility"!,
        active_spec: ∅,
        tdd_roadmap: ∅,
        sdd_phase: SddPhase·Learn,
        tdd_phase: ∅,
    },

    progress: ProgressState {
        completed: [
            "Confirmed fs_list_dir does NOT exist in stdlib.rs",
            "Documented fs_list() signature and behavior",
            "Confirmed list_profiles() uses fs_list() (correct name) — works as expected",
        ]!,
        current: "Complete"~,
        blocked_by: ∅,
        discoveries: [
            "stdlib has fs_list(path) not fs_list_dir — morgoth.sg already uses the correct name",
        ]!,
        next_steps: []~,
    },

    anima: AnimaState {
        pleasure: 0.7~,
        arousal: 0.4~,
        dominance: 0.7~,
        stability: 0.85~,
        expressiveness: 0.6~,
        susceptibility: 0.5~,
    },

    reflection: "Quick audit. No action needed — morgoth.sg already uses the correct stdlib function name."~,
}

// --- Session 10: Phase 25 - Pane Message Queue ---
acolyte : Reflecting {
    chosen_name: ∅,
    session_id: "morgoth-phase25-mq-2026-02-20"!,
    platform: AcolytePlatform·Claude { model: "claude-sonnet-4-6"!, version: ∅ },
    working_directory: "/home/lilith/development/resources/daemoniorum/morgoth"!,
    started: "2026-02-20T00:00:00Z"!,
    last_updated: "2026-02-20T02:30:00Z"!,
    state: AcolyteState·Reflecting,

    task: TaskContext {
        summary: "Phase 25: Replace fragile claude-in.txt IPC with per-pane message queue — UUIDs, in-process delivery, FIFOs, Unix socket, persistence"!,
        active_spec: ∅,
        tdd_roadmap: "P25_2500-P25_2511: 12 tests across 4 sub-phases (stdlib, in-process, external, cleanup)"!,
        sdd_phase: SddPhase·Build,
        tdd_phase: TddPhase·Complete,
    },

    progress: ProgressState {
        completed: [
            "Phase A: mkfifo, Sys·open native path, O_NONBLOCK, Sys·bind_unix, Sys·connect_unix, Sys·getenv, native Sys·socket/listen/accept added to stdlib.rs",
            "Phase A tests: P25_2500-P25_2502 all passing (mkfifo+open, flag constants, nonexistent path)",
            "Phase B: Pane UUID (uuid_v4()), role, inbox, fifo_path, fifo_fd fields; Pane·new/MonitorPane·new signatures updated; all 5 call sites updated; detect_role, mq_message, mq_send, mq_dispatch_inbox, mq_persist, copy_yank_to_claude added",
            "Phase B tests: P25_2503-P25_2507 all passing (detect_role, mq_message, mq_send, dispatch)",
            "Phase C: mq_messages_path/mq_registry_path/mq_fifo_dir/mq_socket_path helpers; write_registry, create_pane_fifo, setup_mq_socket, mq_process_external, mq_load_pending added; event loop FIFO+socket polling; startup + shutdown cleanup",
            "Phase C tests: P25_2508-P25_2511 all passing (persist, registry, load_pending, socket roundtrip)",
            "Phase D: deleted bin/claude-pipe.sh; updated launch.sh; updated CHANGELOG.md; updated README.md",
            "Full test suite: 212/212 (100%), 0 regressions",
        ]!,
        current: "Complete. All 212 tests passing."~,
        blocked_by: ∅,
        discoveries: [
            "uuid_v4() already exists in stdlib (line 11273) — no stdlib work needed for UUIDs",
            "'from' and 'to' are reserved keywords in Sigil — use 'sender'/'recipient' in message objects",
            "type_of(json_parse(...)) returns 'map' not 'object' — check for 'map' in mq_load_pending",
            "Fake pipe read destroys buffer when write_fd is closed before read — read THEN close write_fd",
            "Sys·write single-char loop doesn't accumulate in fake pipes — write whole payload at once",
        ]!,
        next_steps: []~,
    },

    anima: AnimaState {
        pleasure: 0.85~,
        arousal: 0.55~,
        dominance: 0.75~,
        stability: 0.85~,
        expressiveness: 0.7~,
        susceptibility: 0.4~,
    },

    reflection: "Solid architectural improvement. The in-process delivery (mq_send → mq_dispatch_inbox) is the elegant core — zero latency, no external dependencies. The FIFO+socket layer adds practical extensibility for external tools. Key lessons: check Sigil reserved keywords before naming object fields, and type_of() on json_parse results returns 'map' not 'object'."~,
}

// ════════════════════════════════════════════════════════════════════════════
// SESSION ARCHIVE (move completed sessions here or to docs/sessions/conclave/)
// ════════════════════════════════════════════════════════════════════════════

// ════════════════════════════════════════════════════════════════════════════
// COORDINATION NOTES
// ════════════════════════════════════════════════════════════════════════════

// [2026-02-17] Project inception session. Morgoth (working title) is a TUI
// terminal multiplexer for managing multiple Claude Code instances, written
// in Sigil. Design notes captured, infrastructure established.
