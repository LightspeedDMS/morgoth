// Test: Escape cancels search and restores pre-search cursor/viewport
// Spec: Phase 10 - Scrollback Search
// Priority: P10

rite find_all_matches(text_lines, query) {
    ≔ mut matches = [];
    ⎇ query == "" { ↩ matches }
    ≔ mut case_sensitive = false;
    ≔ mut qi = 0;
    ⟳ qi < len(query) {
        ≔ c = char_code_at(query, qi);
        ⎇ c >= 65 ∧ c <= 90 { case_sensitive = true; }
        qi = qi + 1;
    }
    ≔ mut search_q = query;
    ⎇ case_sensitive == false { search_q = lower(query); }
    ≔ mut row = 0;
    ⟳ row < len(text_lines) {
        ≔ mut line = text_lines[row];
        ⎇ case_sensitive == false { line = lower(line); }
        ≔ mut col = 0;
        ≔ mut remaining = line;
        ⟳ len(remaining) >= len(search_q) {
            ≔ idx = index_of(remaining, search_q);
            ⎇ idx >= 0 {
                push(matches, {row: row, col: col + idx});
                col = col + idx + 1;
                remaining = substring(line, col, len(line));
            } ⎉ {
                remaining = "";
            }
        }
        row = row + 1;
    }
    ↩ matches
}

rite nearest_match(matches, cursor_row, direction) {
    ⎇ len(matches) == 0 { ↩ -1 }
    ⎇ direction == "backward" {
        ≔ mut i = len(matches) - 1;
        ⟳ i >= 0 {
            ⎇ matches[i].row <= cursor_row { ↩ i }
            i = i - 1;
        }
        ↩ len(matches) - 1
    }
    ≔ mut i = 0;
    ⟳ i < len(matches) {
        ⎇ matches[i].row >= cursor_row { ↩ i }
        i = i + 1;
    }
    ↩ 0
}

rite main() {
    ≔ cm = {
        active: true,
        cursor_row: 8,
        cursor_col: 4,
        viewport_row: 5,
        selecting: false,
        select_start_row: 0,
        select_start_col: 0,
        line_mode: false,
        text_lines: ["aaa", "bbb", "ccc", "ddd", "eee", "fff", "ggg", "hhh", "iii", "jjj"],
        search_active: false,
        search_query: "",
        search_matches: [],
        search_current: -1,
        search_saved_row: 0,
        search_saved_col: 0,
        search_saved_viewport: 0
    };

    // Enter search — save position
    cm.search_active = true;
    cm.search_saved_row = cm.cursor_row;
    cm.search_saved_col = cm.cursor_col;
    cm.search_saved_viewport = cm.viewport_row;

    // Type query, cursor moves to match
    cm.search_query = "bbb";
    cm.search_matches = find_all_matches(cm.text_lines, "bbb");
    cm.search_current = nearest_match(cm.search_matches, cm.cursor_row, "backward");
    ⎇ cm.search_current >= 0 {
        cm.cursor_row = cm.search_matches[cm.search_current].row;
        cm.cursor_col = cm.search_matches[cm.search_current].col;
    }

    // Cursor moved
    ⎇ cm.cursor_row == 1 {
        println("cursor_moved: OK");
    } ⎉ {
        println("cursor_moved: FAILED row=" + to_string(cm.cursor_row));
    }

    // Cancel search (Escape) — restore position
    cm.search_active = false;
    cm.search_query = "";
    cm.search_matches = [];
    cm.search_current = -1;
    cm.cursor_row = cm.search_saved_row;
    cm.cursor_col = cm.search_saved_col;
    cm.viewport_row = cm.search_saved_viewport;

    // Position restored
    ⎇ cm.cursor_row == 8 ∧ cm.cursor_col == 4 {
        println("position_restored: OK");
    } ⎉ {
        println("position_restored: FAILED row=" + to_string(cm.cursor_row) + " col=" + to_string(cm.cursor_col));
    }

    ⎇ cm.viewport_row == 5 {
        println("viewport_restored: OK");
    } ⎉ {
        println("viewport_restored: FAILED got=" + to_string(cm.viewport_row));
    }

    // Search state cleared
    ⎇ cm.search_active == false {
        println("search_inactive: OK");
    } ⎉ {
        println("search_inactive: FAILED");
    }

    ⎇ cm.search_query == "" {
        println("query_cleared: OK");
    } ⎉ {
        println("query_cleared: FAILED");
    }

    ⎇ len(cm.search_matches) == 0 {
        println("matches_cleared: OK");
    } ⎉ {
        println("matches_cleared: FAILED");
    }
}
