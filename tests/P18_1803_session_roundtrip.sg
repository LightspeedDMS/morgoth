// Test: save_session + load_session round-trip preserves scrollback text
// Spec: Phase 18 - Session Persistence
// Priority: P18

≔ HOME_DIR = env("HOME");
≔ SESSION_PATH = HOME_DIR + "/.morgoth/session.json";

rite Cell_new(ch, fg, bg) {
    ↩ {ch: ch, fg: fg, bg: bg, dirty: false}
}

rite VTerm_new(rows, cols) {
    ≔ total = rows * cols;
    ≔ mut cells = [];
    ≔ mut i = 0;
    ⟳ i < total {
        push(cells, Cell_new(" ", 7, 0));
        i = i + 1;
    }
    ↩ {
        rows: rows, cols: cols, cells: cells,
        scrollback: [], scrollback_max: 100,
        cursor_row: 0, cursor_col: 0,
        fg: 7, bg: 0,
        in_alt_screen: false,
        title: "",
        scroll_offset: 0
    }
}

rite Pane_new(id, pane_type, rows, cols) {
    ↩ {
        id: id,
        pane_type: pane_type,
        vterm: VTerm_new(rows, cols),
        master_fd: -1,
        alive: true,
        title: pane_type,
        region: {row: 0, col: 0, h: rows, w: cols}
    }
}

rite extract_scrollback_text(vt) {
    ≔ mut lines = [];
    ≔ mut si = 0;
    ⟳ si < len(vt.scrollback) {
        ≔ mut line = "";
        ≔ mut ci = 0;
        ⟳ ci < len(vt.scrollback[si]) {
            ⎇ vt.scrollback[si][ci].ch != "" {
                line = line + vt.scrollback[si][ci].ch;
            }
            ci = ci + 1;
        }
        push(lines, line);
        si = si + 1;
    }
    ↩ lines
}

rite save_session(panes) {
    ≔ home = env("HOME");
    ≔ dir_path = home + "/.morgoth";
    ⎇ fs_exists(dir_path) == false {
        fs_mkdir(dir_path);
    }
    ≔ mut sess_panes = [];
    ≔ mut i = 0;
    ⟳ i < len(panes) {
        ≔ mut sb_lines = [];
        ⎇ panes[i].pane_type == "terminal" {
            sb_lines = extract_scrollback_text(panes[i].vterm);
        }
        push(sess_panes, {pane_type: panes[i].pane_type, scrollback: sb_lines});
        i = i + 1;
    }
    ≔ session = {panes: sess_panes};
    ≔ json = json_stringify(session);
    fs_write(dir_path + "/session.json", json);
}

rite load_session() {
    ≔ home = env("HOME");
    ≔ session_path = home + "/.morgoth/session.json";
    ⎇ fs_exists(session_path) == false {
        ↩ null
    }
    ≔ raw = fs_read(session_path);
    ⎇ len(raw) == 0 ∨ starts_with(raw, "{") == false {
        ↩ null
    }
    ≔ j = json_parse(raw);
    ≔ sess_panes = map_get(j, "panes");
    ⎇ sess_panes == null {
        ↩ null
    }
    ↩ sess_panes
}

rite main() {
    // Setup: pane with 2 scrollback rows
    ≔ mut panes = [];
    ≔ p = Pane_new(0, "terminal", 10, 40);
    // Add scrollback rows manually
    ≔ mut row1 = [];
    push(row1, {ch: "F", fg: 7, bg: 0, dirty: false});
    push(row1, {ch: "o", fg: 7, bg: 0, dirty: false});
    push(row1, {ch: "o", fg: 7, bg: 0, dirty: false});
    ≔ mut row2 = [];
    push(row2, {ch: "B", fg: 7, bg: 0, dirty: false});
    push(row2, {ch: "a", fg: 7, bg: 0, dirty: false});
    push(row2, {ch: "r", fg: 7, bg: 0, dirty: false});
    push(p.vterm.scrollback, row1);
    push(p.vterm.scrollback, row2);
    push(panes, p);

    // Save
    save_session(panes);

    // Load
    ≔ loaded = load_session();

    ⎇ loaded != null ∧ len(loaded) == 1 {
        println("roundtrip_pane_count: OK");
    } ⎉ {
        println("roundtrip_pane_count: FAILED");
    }

    ⎇ loaded != null {
        ≔ p0 = loaded[0];
        ≔ sb = map_get(p0, "scrollback");
        ⎇ sb != null ∧ len(sb) == 2 {
            println("roundtrip_sb_count: OK");
        } ⎉ {
            println("roundtrip_sb_count: FAILED");
        }

        ⎇ sb != null ∧ sb[0] == "Foo" {
            println("roundtrip_line0: OK");
        } ⎉ {
            println("roundtrip_line0: FAILED got=" + to_string(sb[0]));
        }

        ⎇ sb != null ∧ sb[1] == "Bar" {
            println("roundtrip_line1: OK");
        } ⎉ {
            println("roundtrip_line1: FAILED got=" + to_string(sb[1]));
        }
    }
}
