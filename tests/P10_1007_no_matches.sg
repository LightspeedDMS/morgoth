// Test: No matches — search_current stays -1, "Pattern not found" signal
// Spec: Phase 10 - Scrollback Search
// Priority: P10

rite find_all_matches(text_lines, query) {
    ≔ mut matches = [];
    ⎇ query == "" { ↩ matches }
    ≔ mut case_sensitive = false;
    ≔ mut qi = 0;
    ⟳ qi < len(query) {
        ≔ c = char_code_at(query, qi);
        ⎇ c >= 65 ∧ c <= 90 { case_sensitive = true; }
        qi = qi + 1;
    }
    ≔ mut search_q = query;
    ⎇ case_sensitive == false { search_q = lower(query); }
    ≔ mut row = 0;
    ⟳ row < len(text_lines) {
        ≔ mut line = text_lines[row];
        ⎇ case_sensitive == false { line = lower(line); }
        ≔ mut col = 0;
        ≔ mut remaining = line;
        ⟳ len(remaining) >= len(search_q) {
            ≔ idx = index_of(remaining, search_q);
            ⎇ idx >= 0 {
                push(matches, {row: row, col: col + idx});
                col = col + idx + 1;
                remaining = substring(line, col, len(line));
            } ⎉ {
                remaining = "";
            }
        }
        row = row + 1;
    }
    ↩ matches
}

rite nearest_match(matches, cursor_row, direction) {
    ⎇ len(matches) == 0 { ↩ -1 }
    ⎇ direction == "backward" {
        ≔ mut i = len(matches) - 1;
        ⟳ i >= 0 {
            ⎇ matches[i].row <= cursor_row { ↩ i }
            i = i - 1;
        }
        ↩ len(matches) - 1
    }
    ≔ mut i = 0;
    ⟳ i < len(matches) {
        ⎇ matches[i].row >= cursor_row { ↩ i }
        i = i + 1;
    }
    ↩ 0
}

rite main() {
    ≔ lines = ["Hello World", "Foo Bar", "Baz Qux"];

    // Search for something not present
    ≔ matches = find_all_matches(lines, "zzz");
    ≔ current = nearest_match(matches, 2, "backward");

    // No matches found
    ⎇ len(matches) == 0 {
        println("no_matches: OK");
    } ⎉ {
        println("no_matches: FAILED got=" + to_string(len(matches)));
    }

    // current is -1
    ⎇ current == -1 {
        println("current_neg1: OK");
    } ⎉ {
        println("current_neg1: FAILED got=" + to_string(current));
    }

    // Build prompt string as render_copy_mode would
    ≔ query = "zzz";
    ≔ mut prompt = "/" + query;
    ⎇ len(matches) > 0 {
        prompt = prompt + " [" + to_string(current + 1) + "/" + to_string(len(matches)) + "]";
    } ⎉ {
        ⎇ query != "" {
            prompt = prompt + " [Pattern not found]";
        }
    }

    ⎇ prompt == "/zzz [Pattern not found]" {
        println("prompt_text: OK");
    } ⎉ {
        println("prompt_text: FAILED got=" + prompt);
    }

    // Empty query shows no "not found" message
    ≔ empty_q = "";
    ≔ mut prompt2 = "/" + empty_q;
    ⎇ len(matches) > 0 {
        prompt2 = prompt2 + " [1/1]";
    } ⎉ {
        ⎇ empty_q != "" {
            prompt2 = prompt2 + " [Pattern not found]";
        }
    }

    ⎇ prompt2 == "/" {
        println("empty_prompt: OK");
    } ⎉ {
        println("empty_prompt: FAILED got=" + prompt2);
    }
}
