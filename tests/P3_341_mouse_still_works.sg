// Test: Mouse SGR sequence still produces mouse: action
// Spec: Phase 3.4 - Input Escape Forwarding
// Priority: P3

rite InputState_new() {
    ↩ {
        leader_active: false,
        mouse_mode: true,
        escape_buf: "",
        in_escape: false,
        last_escape_buf: ""
    }
}

rite process_input(input_state, byte, pane_count) {
    ≔ mut result = "none";
    ⎇ input_state.in_escape == true {
        input_state.escape_buf = input_state.escape_buf + from_char_code(byte);
        ⎇ (byte == 77 ∨ byte == 109) ∧ len(input_state.escape_buf) > 2 ∧ starts_with(input_state.escape_buf, "[<") == true {
            result = "mouse:" + input_state.escape_buf;
            input_state.in_escape = false;
            input_state.escape_buf = "";
        } ⎉ {
            ⎇ byte >= 64 ∧ byte <= 126 ∧ len(input_state.escape_buf) >= 2 {
                input_state.last_escape_buf = input_state.escape_buf;
                input_state.in_escape = false;
                input_state.escape_buf = "";
                result = "forward_esc";
            }
        }
    } ⎉ {
        ⎇ byte == 27 {
            input_state.in_escape = true;
            input_state.escape_buf = "";
        } ⎉ {
            result = "passthrough";
        }
    }
    result
}

rite main() {
    ≔ input = InputState_new();

    // Feed mouse SGR click: ESC [ < 0 ; 1 0 ; 5 M
    // bytes: 27, 91, 60, 48, 59, 49, 48, 59, 53, 77
    ≔ m1 = process_input(input, 27, 1);   // ESC
    ≔ m2 = process_input(input, 91, 1);   // [
    ≔ m3 = process_input(input, 60, 1);   // <
    ≔ m4 = process_input(input, 48, 1);   // 0
    ≔ m5 = process_input(input, 59, 1);   // ;
    ≔ m6 = process_input(input, 49, 1);   // 1
    ≔ m7 = process_input(input, 48, 1);   // 0
    ≔ m8 = process_input(input, 59, 1);   // ;
    ≔ m9 = process_input(input, 53, 1);   // 5
    ≔ res = process_input(input, 77, 1);  // M

    ⎇ starts_with(res, "mouse:") == true {
        println("mouse_sgr_detected: OK");
    } ⎉ {
        println("mouse_sgr_detected: FAILED result=" + res);
    }

    // Mouse release: ends with m (109)
    ≔ r1 = process_input(input, 27, 1);
    ≔ r2 = process_input(input, 91, 1);
    ≔ r3 = process_input(input, 60, 1);
    ≔ r4 = process_input(input, 48, 1);
    ≔ r5 = process_input(input, 59, 1);
    ≔ r6 = process_input(input, 49, 1);
    ≔ r7 = process_input(input, 48, 1);
    ≔ r8 = process_input(input, 59, 1);
    ≔ r9 = process_input(input, 53, 1);
    ≔ res2 = process_input(input, 109, 1);  // m

    ⎇ starts_with(res2, "mouse:") == true {
        println("mouse_release_detected: OK");
    } ⎉ {
        println("mouse_release_detected: FAILED result=" + res2);
    }
}
