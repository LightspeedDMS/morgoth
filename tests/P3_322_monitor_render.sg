// Test: monitor_render writes to VTerm, cells contain content
// Spec: Phase 3.2 - Monitor Pane Wiring
// Priority: P3

rite VTerm_new(rows, cols) {
    ≔ total = rows * cols;
    ≔ mut cells = [];
    ≔ mut i = 0;
    ⟳ i < total {
        push(cells, {ch: " ", fg: 7, bg: 0});
        i = i + 1;
    }
    ↩ {
        cells: cells, rows: rows, cols: cols,
        cursor_row: 0, cursor_col: 0,
        attr_fg: 7, attr_bg: 0,
        esc_state: "normal", esc_buf: "",
        scroll_top: 0, scroll_bottom: rows - 1,
        saved_row: 0, saved_col: 0,
        scrollback: [], scrollback_max: 1000, scroll_offset: 0,
        alt_cells: [], alt_cursor_row: 0, alt_cursor_col: 0,
        alt_attr_fg: 7, alt_attr_bg: 0,
        in_alt_screen: false, cursor_visible: true,
        app_cursor_keys: false, auto_wrap: true,
        bracketed_paste: false, mouse_mode: 0,
        mouse_sgr: false, origin_mode: false, title: ""
    }
}

rite vterm_put_char(vt, ch) {
    ⎇ vt.cursor_col >= vt.cols {
        vt.cursor_col = 0;
        vt.cursor_row = vt.cursor_row + 1;
    }
    ≔ idx = vt.cursor_row * vt.cols + vt.cursor_col;
    ⎇ idx >= 0 ∧ idx < len(vt.cells) {
        vt.cells[idx] = {ch: ch, fg: vt.attr_fg, bg: vt.attr_bg};
    }
    vt.cursor_col = vt.cursor_col + 1;
}

rite vterm_feed(vt, data) {
    ≔ mut i = 0;
    ⟳ i < len(data) {
        ≔ ch = to_string(char_at(data, i));
        ≔ code = char_code_at(data, i);
        ⎇ vt.esc_state == "normal" {
            ⎇ code == 13 { vt.cursor_col = 0; }
            ⎉ { ⎇ code == 10 { vt.cursor_row = vt.cursor_row + 1; vt.cursor_col = 0; }
            ⎉ { ⎇ code >= 32 { vterm_put_char(vt, ch); } } }
        }
        i = i + 1;
    }
    vt.scroll_offset = 0;
}

rite format_number(n) {
    ≔ mut result = to_string(n);
    ⎇ n >= 1000000 {
        ≔ m = n / 1000;
        result = to_string(m / 1000) + "." + to_string((m % 1000) / 100) + "M";
    } ⎉ {
        ⎇ n >= 1000 {
            result = to_string(n / 1000) + "." + to_string((n % 1000) / 100) + "K";
        }
    }
    result
}

rite monitor_render(vt, stats) {
    ≔ mut ei = 0;
    ⟳ ei < len(vt.cells) {
        vt.cells[ei] = {ch: " ", fg: 7, bg: 0};
        ei = ei + 1;
    }
    vt.cursor_row = 0;
    vt.cursor_col = 0;

    ⎇ stats == null {
        vterm_feed(vt, " Claude Code Monitor\n");
        vterm_feed(vt, " No data available\n");
    } ⎉ {
        vterm_feed(vt, " Claude Code Monitor\n");
        ≔ mut sessions_str = "?";
        ≔ ts = map_get(stats, "totalSessions");
        ⎇ ts != null { sessions_str = to_string(ts); }
        vterm_feed(vt, " Sessions: " + sessions_str + "\n");
    }
}

rite main() {
    ≔ vt = VTerm_new(10, 30);

    // Test with null stats
    monitor_render(vt, null);

    // First row should contain "Claude Code Monitor"
    // Check cell at col 1 (after the space) = "C"
    ⎇ vt.cells[1].ch == "C" ∧ vt.cells[2].ch == "l" {
        println("monitor_null_header: OK");
    } ⎉ {
        println("monitor_null_header: FAILED c1=" + vt.cells[1].ch);
    }

    // Row 1 should have "No data"
    ⎇ vt.cells[31].ch == "N" {
        println("monitor_null_nodata: OK");
    } ⎉ {
        println("monitor_null_nodata: FAILED c=" + vt.cells[31].ch);
    }

    // Test with real stats
    ≔ stats = json_parse("{\"totalSessions\": 42, \"totalMessages\": 1500}");
    monitor_render(vt, stats);

    // Check header written
    ⎇ vt.cells[1].ch == "C" {
        println("monitor_stats_header: OK");
    } ⎉ {
        println("monitor_stats_header: FAILED");
    }

    // Check sessions line (row 1, starting at col 1)
    // " Sessions: 42"
    ⎇ vt.cells[31].ch == "S" {
        println("monitor_stats_sessions: OK");
    } ⎉ {
        println("monitor_stats_sessions: FAILED c=" + vt.cells[31].ch);
    }
}
