// P15_1512: Status bar normal hints use ^B+ prefix
≔ VERSION = "0.1.0";

rite Cell_new(ch, fg, bg, dirty) {
    ↩ {ch: ch, fg: fg, bg: bg, dirty: dirty}
}

rite Grid_new(rows, cols) {
    ≔ total = rows * cols;
    ≔ mut cells = [];
    ≔ mut i = 0;
    ⟳ i < total {
        push(cells, Cell_new(" ", 7, 0, true));
        i = i + 1;
    }
    ↩ {rows: rows, cols: cols, cells: cells}
}

rite Grid_set(grid, row, col, ch, fg, bg) {
    ⎇ row >= 0 ∧ row < grid.rows ∧ col >= 0 ∧ col < grid.cols {
        ≔ idx = row * grid.cols + col;
        grid.cells[idx] = Cell_new(ch, fg, bg, true);
    }
}

rite Grid_get(grid, row, col) {
    ⎇ row >= 0 ∧ row < grid.rows ∧ col >= 0 ∧ col < grid.cols {
        ≔ idx = row * grid.cols + col;
        ↩ grid.cells[idx]
    }
    ↩ Cell_new(" ", 7, 0, false)
}

rite render_status_bar_styled(grid, focus, panes, mode) {
    ≔ row = grid.rows - 1;
    ≔ mut col = 0;
    ⟳ col < grid.cols {
        Grid_set(grid, row, col, " ", 7, 0);
        col = col + 1;
    }
    col = 0;

    // Mode pill
    ≔ mut pill = " NORMAL ";
    ≔ mut pill_bg = 2;
    ⎇ mode == "leader" {
        pill = " LEADER ";
        pill_bg = 4;
    }
    ≔ mut pi = 0;
    ⟳ pi < len(pill) ∧ col < grid.cols {
        Grid_set(grid, row, col, to_string(char_at(pill, pi)), 0, pill_bg);
        col = col + 1;
        pi = pi + 1;
    }

    // Pane info
    ≔ pane_info = " [" + to_string(focus + 1) + "/" + to_string(len(panes)) + "] " + panes[focus].pane_type + " ";
    ≔ mut ii = 0;
    ⟳ ii < len(pane_info) ∧ col < grid.cols {
        Grid_set(grid, row, col, to_string(char_at(pane_info, ii)), 15, 0);
        col = col + 1;
        ii = ii + 1;
    }

    // Separator
    ⎇ col < grid.cols {
        Grid_set(grid, row, col, "│", 8, 0);
        col = col + 1;
    }

    // Hints
    ≔ mut hints = "";
    ⎇ mode == "normal" ∨ mode == "leader" {
        hints = " ^B+c: new  ^B+x: close  ^B+z: zoom  ^B+/: search  ^B+q: quit";
    }
    ≔ mut hi = 0;
    ⟳ hi < len(hints) ∧ col < grid.cols {
        Grid_set(grid, row, col, to_string(char_at(hints, hi)), 7, 0);
        col = col + 1;
        hi = hi + 1;
    }
}

rite main() {
    ≔ grid = Grid_new(2, 100);
    ≔ panes = [{pane_type: "terminal"}];

    render_status_bar_styled(grid, 0, panes, "normal");

    // Read status bar row and build string
    ≔ mut status = "";
    ≔ mut c = 0;
    ⟳ c < 100 {
        ≔ cell = Grid_get(grid, 1, c);
        status = status + cell.ch;
        c = c + 1;
    }

    // Check for ^B+ prefix in hints
    ≔ mut found_prefix = false;
    ≔ mut i = 0;
    ⟳ i < len(status) - 3 {
        ⎇ substring(status, i, i + 3) == "^B+" {
            found_prefix = true;
        }
        i = i + 1;
    }

    ⎇ found_prefix == true {
        println("hints_have_prefix: OK");
    } ⎉ {
        println("hints_have_prefix: FAILED status=" + status);
    }
}
