// Test: Incremental search — each char narrows matches, backspace widens
// Spec: Phase 10 - Scrollback Search
// Priority: P10

rite find_all_matches(text_lines, query) {
    ≔ mut matches = [];
    ⎇ query == "" { ↩ matches }
    ≔ mut case_sensitive = false;
    ≔ mut qi = 0;
    ⟳ qi < len(query) {
        ≔ c = char_code_at(query, qi);
        ⎇ c >= 65 ∧ c <= 90 { case_sensitive = true; }
        qi = qi + 1;
    }
    ≔ mut search_q = query;
    ⎇ case_sensitive == false { search_q = lower(query); }
    ≔ mut row = 0;
    ⟳ row < len(text_lines) {
        ≔ mut line = text_lines[row];
        ⎇ case_sensitive == false { line = lower(line); }
        ≔ mut col = 0;
        ≔ mut remaining = line;
        ⟳ len(remaining) >= len(search_q) {
            ≔ idx = index_of(remaining, search_q);
            ⎇ idx >= 0 {
                push(matches, {row: row, col: col + idx});
                col = col + idx + 1;
                remaining = substring(line, col, len(line));
            } ⎉ {
                remaining = "";
            }
        }
        row = row + 1;
    }
    ↩ matches
}

rite main() {
    ≔ lines = ["apple banana", "application", "appreciate", "banana only"];

    // Simulate incremental search: type "a" then "p" then "p" then "l"
    // "a" → all lines with 'a' somewhere
    ≔ m1 = find_all_matches(lines, "a");
    println("query_a: " + to_string(len(m1)));

    // "ap" → narrows
    ≔ m2 = find_all_matches(lines, "ap");
    println("query_ap: " + to_string(len(m2)));

    // "app" → narrows further
    ≔ m3 = find_all_matches(lines, "app");
    println("query_app: " + to_string(len(m3)));

    // "appl" → narrows more
    ≔ m4 = find_all_matches(lines, "appl");
    println("query_appl: " + to_string(len(m4)));

    // "apple" → only "apple banana"
    ≔ m5 = find_all_matches(lines, "apple");
    println("query_apple: " + to_string(len(m5)));

    // Backspace to "appl" → widens back
    ≔ m6 = find_all_matches(lines, "appl");
    println("backspace_appl: " + to_string(len(m6)));

    // Verify narrowing is monotonic
    ⎇ len(m1) >= len(m2) ∧ len(m2) >= len(m3) ∧ len(m3) >= len(m4) ∧ len(m4) >= len(m5) {
        println("monotonic: OK");
    } ⎉ {
        println("monotonic: FAILED");
    }

    // Verify backspace widens
    ⎇ len(m6) == len(m4) {
        println("backspace_widens: OK");
    } ⎉ {
        println("backspace_widens: FAILED");
    }
}
